#!/bin/bash
# nix-init - Initialize and switch nix-darwin configuration

set -euo pipefail

USER=$(whoami)
FLAKE_DIR="${HOME}/.config/home-manager"

# Get the profile from flake metadata or default to username
PROFILE="${PROFILE:-$USER}"

if [[ ! -d "$FLAKE_DIR" ]]; then
    echo "Error: Flake directory not found: $FLAKE_DIR" >&2
    exit 1
fi

echo "Initializing darwin configuration for user: $PROFILE"
cd "$FLAKE_DIR"

# Build the darwin configuration
nix build ".#darwinConfigurations.${PROFILE}.config.system.build.toplevel"

# Switch to the new configuration
sudo ./result/sw/bin/darwin-rebuild switch --flake ".#${PROFILE}"

# Cleanup
rm -f result

echo "Done! Start a new shell or run: exec zsh"
